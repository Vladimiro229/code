<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Коди виробів — список для дизайнерів</title>
  <style>
    :root{
      --bg:#e6e6e6;--card:#ffffff;--text:#111;--muted:#6b7280;--radius:14px;--shadow:0 6px 18px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Segoe UI",system-ui,-apple-system,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:28px 16px}
    header{display:flex;align-items:end;justify-content:space-between;margin-bottom:18px}
    h1{font-size:26px;margin:0;font-weight:700}
    .hint{font-size:12px;color:var(--muted)}

    .section{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:18px;overflow:hidden}
    .section h2{margin:0;padding:14px 16px;font-size:16px;border-bottom:1px solid #efefef}

    .list{display:flex;flex-direction:column;padding:8px}
    .row{display:flex;gap:12px;align-items:center;border:1px solid #eee;border-radius:12px;padding:10px 12px;margin:6px;cursor:pointer;transition:.15s transform, .15s box-shadow;background:#fff}
    .row:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(0,0,0,.06)}

    .code{font-family:ui-monospace, Menlo, Consolas, "Liberation Mono", monospace;background:#111;color:#fff;border-radius:8px;padding:6px 10px;white-space:nowrap}
    .meta{display:flex;gap:8px;flex-wrap:wrap;min-width:0}
    .chip{border:1px solid #e5e7eb;border-radius:999px;padding:4px 10px;font-size:12px;background:#fafafa;white-space:nowrap}
    .muted{color:var(--muted)}
    footer{text-align:center;margin-top:10px;color:var(--muted);font-size:12px}

    .toast{position:fixed;left:50%;bottom:28px;transform:translateX(-50%);background:#111;color:#fff;border-radius:12px;padding:10px 14px;opacity:0;pointer-events:none;transition:.25s}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Коди для макетів</h1>
      <div class="hint">Натисни на рядок — код скопіюється у буфер. Дані тягнуться з приватної таблиці через Apps Script.</div>
    </header>

    <div id="container"></div>
    <footer>Останнє оновлення: <span id="updated">—</span></footer>
  </div>

  <div id="toast" class="toast">Скопійовано</div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyGLJRZvCoZ7EBCQenEGxr8Ap3VbreW_0WAVG20cIFIQC6LDFrUKxG4M_mjADP3koUy/exec";
    const TECHNOLOGY_HEADERS = ["ТЦ", "Технологія", "Технології", "Tech"];
    const CODE_HEADERS = ["Код", "Code", "Артикул", "Назва коду"];
    const CHIP_CANDIDATES = ["Стаціонарний цифр.", "Стаціонарні цифр.", "Стаціонарні цифри", "Циферблат", "Шари", "Одиночковий", "Двошаровий", "Матеріал", "Алюміній", "Гільза", "2D мітки", "3D мітки", "Напилок"];
    const TECH_ORDER = ["УФ", "Лазер", "УФ+Лазер", "Лазер+УФ"];

    let headers = [];
    let rows = [];
    let codeKey = null;
    let techKey = null;

    const $ = (s)=>document.querySelector(s);
    const container = $("#container");
    const toastEl = $("#toast");

    async function load(){
      const res = await fetch(WEB_APP_URL);
      if(!res.ok) throw new Error("Не вдалось завантажити дані з веб-апки");
      const { headers: hs, rows: rs, updated } = await res.json();
      headers = hs || [];
      rows = rs || [];

      techKey = headers.find(h => TECHNOLOGY_HEADERS.some(x => h.toLowerCase().includes(x.toLowerCase()))) || headers[1];
      codeKey = headers.find(h => CODE_HEADERS.includes(h)) || headers[0];

      render();
      document.getElementById('updated').textContent = updated ? new Date(updated).toLocaleString() : new Date().toLocaleString();
    }

    function render(){
      const groups = {};
      rows.forEach(row=>{
        const raw = (row[techKey]||"").toString().toLowerCase();
        const tech = normalizeTech(raw);
        (groups[tech] ||= []).push(row);
      });

      container.innerHTML = "";
      TECH_ORDER.concat(Object.keys(groups).filter(k=>!TECH_ORDER.includes(k))).forEach(tech=>{
        if(!groups[tech]||!groups[tech].length) return;
        const sec = document.createElement('section');
        sec.className = 'section';
        sec.innerHTML = `<h2>${tech}</h2><div class="list"></div>`;
        const list = sec.querySelector('.list');
        groups[tech].forEach(row=> list.appendChild(renderRow(row)) );
        container.appendChild(sec);
      });
    }

    function renderRow(row){
      const el = document.createElement('div');
      el.className = 'row';
      const code = row[codeKey] || row[headers[0]] || '';
      const chips = makeChips(row);
      el.innerHTML = `
        <div class="code" title="Натисни, щоб скопіювати код">${escapeHtml(code)}</div>
        <div class="meta">${chips.map(c=>`<span class=\"chip\">${escapeHtml(c)}</span>`).join('')}</div>
      `;
      el.addEventListener('click', ()=>copy(code));
      return el;
    }

    function makeChips(row){
      const found = [];
      CHIP_CANDIDATES.forEach(name=>{
        const key = headers.find(h=>h.toLowerCase()===name.toLowerCase());
        if(key && row[key]) found.push(`${key}: ${row[key]}`);
      });
      if(!found.length){
        headers.slice(1,4).forEach(h=>{ if(row[h]) found.push(`${h}: ${row[h]}`); });
      }
      return found;
    }

    function normalizeTech(s){
      if(s.includes('уф') && s.includes('лаз')) return s.indexOf('уф') < s.indexOf('лаз') ? 'УФ+Лазер' : 'Лазер+УФ';
      if(s.includes('уф')) return 'УФ';
      if(s.includes('лаз')) return 'Лазер';
      return 'Інше';
    }

    async function copy(text){
      if(!text) return;
      try{ await navigator.clipboard.writeText(text); showToast('Скопійовано: ' + text); }
      catch{ showToast('Не вдалось скопіювати'); }
    }

    function showToast(msg){
      toastEl.textContent = msg; toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), 1500);
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));
    }

    load().catch(e=>{ console.error('LOAD_ERROR', e); const msg = (e && e.message) ? e.message : 'Помилка завантаження даних'; showToast(msg); container.innerHTML = `<div style="padding:16px;color:#e11d48">${msg}</div>`; });
  </script>
</body>
</html>
